<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Workshop 2</title>
  <style>
    span {
      margin-right: 1.5em;
    }
  </style>
</head>
<body>
<h1>Using fetch to access MTR Next Train API</h1>
<label for="line">Choose the MTR line:</label>
<select name="line" id="line">
  <option value="AEL" selected>Airport Express</option>
  <option value="TCL">Tung Chung Line</option>
  <option value="WRL">West Rail Line</option>
  <option value="TKL">Tseung Kwan O Line</option>
</select>
<br><br>
<label for="station">Choose the Station:</label>
<select name="station" id="station">
   <option class="AEL" value="HOK">Hong Kong</option> <!-- class seems only for CSS -->
  <option class="AEL" value="KOW">Kowloon</option> 
  <option class="AEL" value="TSY">Tsing Yi</option>
  <option class="AEL" value="AIR">Airport</option>
  <option class="AEL" value="AWE">AsiaWorld Expo</option>
</select>
<br><br>
<button id="bttn">Get Train Data</button>
<div id="output" style="margin-top: 1rem"></div>

<script>
  const Stations = {
    'AEL': '<option class="AEL" value="HOK">Hong Kong</option> \
      <option class="AEL" value="KOW">Kowloon</option> \
      <option class="AEL" value="TSY">Tsing Yi</option> \
      <option class="AEL" value="AIR">Airport</option> \
      <option class="AEL" value="AWE">AsiaWorld Expo</option>',
    'TCL': '<option class="TCL" value="HOK">Hong Kong</option> \
      <option class="TCL" value="KOW">Kowloon</option> \
      <option class="TCL" value="OLY">Olympic</option> \
      <option class="TCL" value="NAC">Nam Cheong</option> \
      <option class="TCL" value="LAK">Lai King</option> \
      <option class="TCL" value="TSY">Tsing Yi</option> \
      <option class="TCL" value="SUN">Sunny Bay</option> \
      <option class="TCL" value="TUC">Tung Chung</option>',
    'WRL': '<option class="WRL" value="HUH">Hung Hom</option> \
      <option class="WRL" value="ETS">East Tsim Sha Tsui</option> \
      <option class="WRL" value="AUS">Austin</option> \
      <option class="WRL" value="NAC">Nam Cheong</option> \
      <option class="WRL" value="MEF">Mei Foo</option> \
      <option class="WRL" value="TWW">Tsuen Wan West</option> \
      <option class="WRL" value="KSR">Kam Sheung Road</option> \
      <option class="WRL" value="YUL">Yuen Long</option> \
      <option class="WRL" value="LOP">Long Ping</option> \
      <option class="WRL" value="TIS">Tin Shui Wai</option> \
      <option class="WRL" value="SIH">Siu Hong</option> \
      <option class="WRL" value="TUM">Tuen Mun</option>',
    'TKL': '<option class="TKL" value="NOP">North Point</option> \
      <option class="TKL" value="QUB">Quarry Bay</option> \
      <option class="TKL" value="YAT">Yau Tong</option> \
      <option class="TKL" value="TIK">Tiu Keng Leng</option> \
      <option class="TKL" value="TKO">Tseung Kwan O</option> \
      <option class="TKL" value="LHP">LOHAS Park</option> \
      <option class="TKL" value="HAH">Hang Hau</option> \
      <option class="TKL" value="POA">Po Lam</option>' };

  let currentLine="AEL"; //assume Airport Express line initially
  let line = document.getElementById('line'); // declare variable line to store the <select id='line'> tag 
  line.addEventListener('change', (e) => {
    let selectedLine = line.value; // let selectLine = value of <select>
    if (selectedLine != currentLine) { //there is a change
      //let station = document.querySelector('#station'); // same as the follow document.getElementById('station') in this situation
      let station = document.getElementById('station'); // declare variable station to store the <select id='station'> tag 
      station.innerHTML = Stations[selectedLine]; // choose the selected line and write the to <select value=${station}> innerHTML is here </select> 
      currentLine = selectedLine; // update the currentLine to the selectedLine
    }
  });


// the following is for fetching the API

  const stnList= { "HOK": "Hong Kong", "KOW": "Kowloon", "TSY": "Tsing Yi", "AIR": "Airport", "AWE": "AsiaWorld Expo", "HOK": "Hong Kong", "KOW": "Kowloon", "OLY": "Olympic", "NAC": "Nam Cheong", "LAK": "Lai King", "TSY": "Tsing Yi", "SUN": "Sunny Bay", "TUC": "Tung Chung", "HUH": "Hung Hom", "ETS": "East Tsim Sha Tsui", "AUS": "Austin", "NAC": "Nam Cheong", "MEF": "Mei Foo", "TWW": "Tsuen Wan West", "KSR": "Kam Sheung Road", "YUL": "Yuen Long", "LOP": "Long Ping", "TIS": "Tin Shui Wai", "SIH": "Siu Hong", "TUM": "Tuen Mun", "NOP": "North Point", "QUB": "Quarry Bay", "YAT": "Yau Tong", "TIK": "Tiu Keng Leng", "TKO": "Tseung Kwan O", "LHP": "LOHAS Park", "HAH": "Hang Hau", "POA": "Po Lam" }

  let bttn = document.getElementById('bttn'); // declare variable bttn to store the <button id='bttn'> tag
  bttn.addEventListener("click", fRequest); 

  function fRequest() {

    let line = document.getElementById('line').value;  // declare variable line to store the <select id='line'> tag 
    let station = document.getElementById('station').value; // declare variable station to store the <select id='station'> tag 

  fetch(`https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${line}&sta=${station}`)
    .then( response => {
      if ( response.status == 200) { // HTTP Response
        response.json().then( schedule => { // convert response to JSON format as variable schedule
          let output = "";

          if (schedule.status == 0) { // JSON Response
            output += schedule.message; // JSON.message = Alert message 
          if (schedule.url) // URL for Special Train Services Arrangement case.
            output += `<br><a href='${schedule.url}'>${schedule.url}</a>`;

          } else {
            if (schedule.isdelay == 'Y') {
              output = "No data is available";

            } else { // normal response
              let dataUP = schedule.data[line+'-'+station].UP; // data is array. UP都係array(array in data array). API document 無講清楚，要用firefox睇番JSON先知!
              let dataDN = schedule.data[line+'-'+station].DOWN;

              if (dataUP) { // has the UP data
                for (let train of dataUP) {
                  let time = train.time.substr(11,5);
                  output += '<span>Time: '+time+'</span>';
                  output += '<span>Platform: '+train.plat+'</span>';
                  output += '<span>Destination: '+stnList[train.dest]+'<br></span>';
                }
                output += '<br>';
              }
              if (dataDN) { // has the DN data
                for (let train of dataDN) {
                  if (Object.keys(train).length) {
                    let time = train.time.substr(11,5);
                    output += '<span>Time: '+time+'</span>';
                    output += '<span>Platform: '+train.plat+'</span>';
                    output += '<span>Destination: '+stnList[train.dest]+'<br></span>';
                  }
                }
              }
            }
          }
          // Write the data beneath the button
          document.getElementById('output').innerHTML = output; // write output to the HTML tag with id output
        });
      } else {
        console.log("HTTP return status: "+response.status);
      }
    });
  }
</script>
</body>
</html>